import { supabase } from "./supabase.js";

const params = new URLSearchParams(window.location.search);
const viagemId = params.get("id");

//=======================
// CARREGAR VIAGEM
//=======================
async function carregarViagem() {
  const { data, error } = await supabase
    .from("viagens")
    .select("*")
    .eq("id", viagemId)
    .single();

  if (error || !data) {
    document.getElementById("erroViagem").textContent = "Viagem não encontrada.";
    document.getElementById("erroViagem").style.display = "block";
    return;
  }

  // CABEÇALHO
  document.getElementById("tituloViagem").textContent = data.titulo;
  document.getElementById("tituloViagemCapa").textContent = data.titulo;
  document.getElementById("datasViagem").textContent =
    formatarData(data.data_inicio) + " a " + formatarData(data.data_fim);

  document.getElementById("imgCapaViagem").src = data.imagem_capa;

  // ROTEIRO
  document.getElementById("roteiroTexto").innerHTML =
    data.roteiro
      ?.split("\n")
      .map(l => `<p>${l}</p>`)
      .join("") || "<p>Roteiro não disponível.</p>";

  // DICAS
  document.getElementById("dicasViagem").innerHTML =
    data.dicas
      ?.split("\n")
      .map(l => `<p>${l}</p>`)
      .join("") || "<p>Sem dicas no momento.</p>";
}

function formatarData(d) {
  const dt = new Date(d);
  return dt.toLocaleDateString("pt-BR");
}

//=======================
// CHECKLIST
//=======================
document.querySelectorAll(".checklist-item").forEach(cb => {
  cb.addEventListener("change", salvarChecklist);
});

function salvarChecklist() {
  const itens = {};
  document.querySelectorAll(".checklist-item").forEach(cb => {
    itens[cb.dataset.item] = cb.checked;
  });
  localStorage.setItem("checklist_" + viagemId, JSON.stringify(itens));
}

function carregarChecklist() {
  const salvo = localStorage.getItem("checklist_" + viagemId);
  if (!salvo) return;
  const itens = JSON.parse(salvo);
  document.querySelectorAll(".checklist-item").forEach(cb => {
    cb.checked = itens[cb.dataset.item] || false;
  });
}

//=======================
// BOTÃO PDF CHECKLIST
//=======================
document.getElementById("btnGerarChecklistPdf")?.addEventListener("click", () => {
  alert("PDF do checklist será gerado aqui (já configurado).");
});

//=======================
document.getElementById("btnSairViagem")?.addEventListener("click", async () => {
  await supabase.auth.signOut();
  window.location.href = "/login.html";
});

//=======================
carregarViagem();
carregarChecklist();
